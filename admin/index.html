<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Sunsets & Indicas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg: #0b0f17; --card: #121826; --text: #e5e7eb; --muted:#9ca3af; --brand:#10b981; --danger:#ef4444; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
  header { padding: 20px; border-bottom: 1px solid #1f2937; display:flex; align-items:center; justify-content: space-between; }
  header h1 { margin:0; font-size: 18px; font-weight: 700; }
  header .right { display:flex; gap:10px; align-items:center; }
  main { max-width: 1100px; margin: 24px auto; padding: 0 16px 48px; }
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
  .card { background: var(--card); border:1px solid #1f2937; border-radius: 10px; padding:16px; }
  .card h2 { margin:0 0 10px; font-size:16px; }
  label { display:block; font-size:12px; color: var(--muted); margin: 10px 0 4px; }
  input, textarea { width:100%; background:#0d1420; border:1px solid #233047; color:var(--text); border-radius:8px; padding:10px 12px; outline:none; }
  textarea { min-height: 90px; resize: vertical; }
  .row { display:flex; gap:10px; }
  .row > * { flex:1; }
  button { background: var(--brand); color:#00150f; border:none; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }
  button.secondary { background:#1f2937; color: var(--text); border:1px solid #2b3a54; }
  button.danger { background: var(--danger); color:#fff; }
  .muted { color: var(--muted); font-size: 12px; }
  ul.list { list-style: none; padding:0; margin:0; display:flex; flex-direction: column; gap:8px; max-height: 360px; overflow:auto; }
  .item { display:flex; gap:12px; align-items:center; justify-content: space-between; background:#0d1420; border:1px solid #1f2937; border-radius:8px; padding:10px 12px; }
  .item .meta { display:flex; flex-direction: column; gap:4px; }
  .hidden { display:none !important; }
  .authbar { font-size: 12px; color: var(--muted); }
  .pill { padding: 2px 8px; border-radius: 999px; background:#112e26; color:#7ff0c8; font-size:11px; }
</style>
</head>
<body>
  <header>
    <h1>Admin Dashboard</h1>
    <div class="right">
      <span id="whoami" class="authbar muted">Not signed in</span>
      <button id="btnLogout" class="secondary hidden">Logout</button>
    </div>
  </header>
  <main>
    <div id="loginCard" class="card">
      <h2>Sign in</h2>
      <p class="muted">Use your admin email and password.</p>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="nic@blacnova.net" value="nic@blacnova.net">
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••" value="2900">
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button id="btnLogin">Sign in</button>
        <span id="loginMsg" class="muted"></span>
      </div>
    </div>

    <div id="dash" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Create Blog</h2>
          <label>Title</label>
          <input id="b_title" type="text" placeholder="Title">
          <label>Description</label>
          <textarea id="b_desc" placeholder="Short description"></textarea>
          <div class="row">
            <div>
              <label>Image URL</label>
              <input id="b_image" type="text" placeholder="https://...">
            </div>
            <div>
              <label>Redirect URL</label>
              <input id="b_redirect" type="text" placeholder="https://...">
            </div>
          </div>
          <label>Button Text</label>
          <input id="b_btn" type="text" value="Read">
          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <button id="btnCreateBlog">Publish Blog</button>
            <span id="b_msg" class="muted"></span>
          </div>
        </div>

        <div class="card">
          <h2>Create Issue <span class="pill">admin only</span></h2>
          <label>Title</label>
          <input id="i_title" type="text" placeholder="Title">
          <label>Description</label>
          <textarea id="i_desc" placeholder="Short description"></textarea>
          <div class="row">
            <div>
              <label>Image URL</label>
              <input id="i_image" type="text" placeholder="https://...">
            </div>
            <div>
              <label>Redirect URL</label>
              <input id="i_redirect" type="text" placeholder="https://...">
            </div>
          </div>
          <label>Button Text</label>
          <input id="i_btn" type="text" value="View">
          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <button id="btnCreateIssue">Publish Issue</button>
            <span id="i_msg" class="muted"></span>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="card">
          <h2>Blogs</h2>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="btnRefreshBlogs" class="secondary">Refresh</button>
          </div>
          <ul id="blogsList" class="list"></ul>
        </div>
        <div class="card">
          <h2>Issues</h2>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="btnRefreshIssues" class="secondary">Refresh</button>
          </div>
          <ul id="issuesList" class="list"></ul>
        </div>
      </div>
    </div>
  </main>
<script>
(function(){
  const qs = (id) => document.getElementById(id);
  const state = { email: null, password: null, role: null };

  function base64(s){ return btoa(unescape(encodeURIComponent(s))); }
  function authHeader(){ if(!(state.email && state.password)) return {}; return { 'Authorization': 'Basic ' + base64(state.email+ ':' + state.password) }; }
  async function api(path, opts={}){
    const res = await fetch(path, { ...opts, headers: { 'Content-Type':'application/json', ...(opts.headers||{}), ...authHeader() }});
    if(res.status === 401){ throw new Error('AUTH_REQUIRED'); }
    if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(t || ('HTTP_'+res.status)); }
    const ct = res.headers.get('content-type')||'';
    return ct.includes('application/json') ? res.json() : res.text();
  }

  function saveCreds(){ localStorage.setItem('admin_email', state.email||''); localStorage.setItem('admin_password', state.password||''); }
  function loadCreds(){ state.email = localStorage.getItem('admin_email')||''; state.password = localStorage.getItem('admin_password')||''; }
  function clearCreds(){ state.email = state.password = state.role = null; localStorage.removeItem('admin_email'); localStorage.removeItem('admin_password'); }

  function setSignedInUI(signedIn, email){
    qs('loginCard').classList.toggle('hidden', signedIn);
    qs('dash').classList.toggle('hidden', !signedIn);
    qs('btnLogout').classList.toggle('hidden', !signedIn);
    qs('whoami').textContent = signedIn ? (email + (state.role ? ' ('+state.role+')' : '')) : 'Not signed in';
  }

  async function loadMe(){
    try {
      const me = await api('/api/me');
      state.role = me.role || null;
      setSignedInUI(true, me.email || state.email);
      await Promise.all([refreshBlogs(), refreshIssues()]);
    } catch (e) {
      setSignedInUI(false);
      throw e;
    }
  }

  async function refreshBlogs(){
    const list = qs('blogsList'); list.innerHTML = '<li class="muted">Loading…</li>';
    const items = await api('/api/blogs');
    list.innerHTML = '';
    if(!items.length){ list.innerHTML = '<li class="muted">No blogs yet.</li>'; return; }
    for(const it of items){
      const li = document.createElement('li'); li.className='item';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<strong>${escapeHtml(it.title||'Untitled')}</strong><span class="muted">#${it.id} · ${new Date(it.created_at).toLocaleString()}</span>`;
      const actions = document.createElement('div');
      const del = document.createElement('button'); del.className='danger'; del.textContent = 'Delete';
      del.onclick = async () => { if(!confirm('Delete blog #' + it.id + '?')) return; await api('/api/blogs?id=' + it.id, { method:'DELETE' }); await refreshBlogs(); };
      if(state.role === 'admin') actions.appendChild(del);
      li.appendChild(meta); li.appendChild(actions);
      list.appendChild(li);
    }
  }

  async function refreshIssues(){
    const list = qs('issuesList'); list.innerHTML = '<li class="muted">Loading…</li>';
    const items = await api('/api/issues');
    list.innerHTML = '';
    if(!items.length){ list.innerHTML = '<li class="muted">No issues yet.</li>'; return; }
    for(const it of items){
      const li = document.createElement('li'); li.className='item';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<strong>${escapeHtml(it.title||'Untitled')}</strong><span class="muted">#${it.id} · ${new Date(it.created_at).toLocaleString()}</span>`;
      const actions = document.createElement('div');
      const del = document.createElement('button'); del.className='danger'; del.textContent = 'Delete';
      del.onclick = async () => { if(!confirm('Delete issue #' + it.id + '?')) return; await api('/api/issues?id=' + it.id, { method:'DELETE' }); await refreshIssues(); };
      if(state.role === 'admin') actions.appendChild(del);
      li.appendChild(meta); li.appendChild(actions);
      list.appendChild(li);
    }
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

  // Events
  qs('btnLogin').onclick = async () => {
    const email = qs('email').value.trim();
    const password = qs('password').value;
    qs('loginMsg').textContent = '';
    if(!email || !password){ qs('loginMsg').textContent = 'Enter email and password'; return; }
    state.email = email; state.password = password; saveCreds();
    try { await loadMe(); qs('loginMsg').textContent = ''; } catch(e){ qs('loginMsg').textContent = 'Sign-in failed'; clearCreds(); }
  };

  qs('btnLogout').onclick = () => { clearCreds(); setSignedInUI(false); };

  qs('btnCreateBlog').onclick = async () => {
    qs('b_msg').textContent = '';
    try {
      const payload = { title: qs('b_title').value, description: qs('b_desc').value, image: qs('b_image').value, redirect: qs('b_redirect').value, buttonText: qs('b_btn').value || 'Read' };
      await api('/api/blogs', { method:'POST', body: JSON.stringify(payload) });
      qs('b_msg').textContent = 'Published';
      qs('b_title').value = qs('b_desc').value = qs('b_image').value = qs('b_redirect').value = '';
      qs('b_btn').value = 'Read';
      await refreshBlogs();
    } catch(e) { qs('b_msg').textContent = 'Failed'; }
  };

  qs('btnCreateIssue').onclick = async () => {
    qs('i_msg').textContent = '';
    try {
      const payload = { title: qs('i_title').value, description: qs('i_desc').value, image: qs('i_image').value, redirect: qs('i_redirect').value, buttonText: qs('i_btn').value || 'View' };
      await api('/api/issues', { method:'POST', body: JSON.stringify(payload) });
      qs('i_msg').textContent = 'Published';
      qs('i_title').value = qs('i_desc').value = qs('i_image').value = qs('i_redirect').value = '';
      qs('i_btn').value = 'View';
      await refreshIssues();
    } catch(e) { qs('i_msg').textContent = 'Failed (admin only)'; }
  };

  qs('btnRefreshBlogs').onclick = refreshBlogs;
  qs('btnRefreshIssues').onclick = refreshIssues;

  // Auto restore session
  loadCreds();
  if(state.email && state.password){
    loadMe().catch(()=>{});
  }
})();
</script>
</body>
</html>
